<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Dashboard - DocTypeGen</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
            color: #212529;
            padding-top: 20px;
        }
        .header {
            margin-bottom: 30px;
        }
        .report-card {
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .report-card:hover {
            transform: translateY(-5px);
        }
        .valid-badge {
            background-color: #28a745;
        }
        .stale-badge {
            background-color: #dc3545;
        }
        .card-header {
            font-weight: bold;
        }
        .action-buttons {
            margin-top: 15px;
        }
        .action-buttons .btn {
            margin-right: 8px;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 20px;
        }
        .refresh-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DocTypeGen Reports Dashboard</h1>
            <p>View and manage reports generated by the document processing system.</p>
        </div>

        <div class="refresh-container">
            <h2>Report List</h2>
            <div>
                <button id="generateReportBtn" class="btn btn-primary">Generate New Report</button>
                <button id="refreshBtn" class="btn btn-outline-secondary">Refresh List</button>
            </div>
        </div>

        <div id="loading" class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>

        <div id="noReportsMessage" class="alert alert-info" style="display: none;">
            No reports found. Generate a new report to get started.
        </div>

        <div id="errorMessage" class="alert alert-danger" style="display: none;">
            An error occurred while loading reports.
        </div>

        <div id="reportsList" class="row">
            <!-- Reports will be dynamically added here -->
        </div>

        <div class="footer">
            <p>DocTypeGen Reporting System | <span id="currentDate"></span></p>
        </div>
    </div>

    <script>
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();

        // Helper function to show loading indicator
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // Helper function to hide loading indicator
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Fetch reports from the API
        async function fetchReports() {
            showLoading();
            try {
                const response = await fetch('/report/list');
                if (!response.ok) {
                    throw new Error('Failed to fetch reports');
                }
                const data = await response.json();
                
                hideLoading();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch reports');
                }
                
                return data.result.reports || [];
            } catch (error) {
                hideLoading();
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error: ' + error.message;
                console.error('Error fetching reports:', error);
                return [];
            }
        }

        // Generate report HTML element
        function createReportElement(report) {
            const isFresh = report.is_fresh;
            const statusClass = isFresh ? 'valid-badge' : 'stale-badge';
            const statusText = isFresh ? 'Valid' : 'Stale';
            
            return `
                <div class="col-md-6">
                    <div class="card report-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Report ID: ${report.report_id}</span>
                            <span class="badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="card-body">
                            <p><strong>Session:</strong> ${report.session_hash}</p>
                            <p><strong>Created:</strong> ${report.created_at}</p>
                            <p><strong>Reports:</strong> ${report.report_count || 0}</p>
                            <div class="action-buttons">
                                <a href="/report/${report.report_id}/html/index.html" target="_blank" class="btn btn-primary">View HTML</a>
                                <a href="/report/${report.report_id}/pdf/summary.pdf" target="_blank" class="btn btn-secondary">View PDF</a>
                                <button class="btn btn-outline-secondary rerun-btn" data-report-id="${report.report_id}">
                                    ${isFresh ? 'Report is Up to Date' : 'Regenerate Report'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render reports to the page
        async function renderReports() {
            const reports = await fetchReports();
            const reportsContainer = document.getElementById('reportsList');
            const noReportsMessage = document.getElementById('noReportsMessage');
            
            reportsContainer.innerHTML = '';
            
            if (reports.length === 0) {
                noReportsMessage.style.display = 'block';
                return;
            }
            
            noReportsMessage.style.display = 'none';
            
            // Sort reports by created_at (newest first)
            reports.sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            reports.forEach(report => {
                reportsContainer.innerHTML += createReportElement(report);
            });
            
            // Add event listeners to rerun buttons
            document.querySelectorAll('.rerun-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const reportId = e.target.dataset.reportId;
                    await rerunReport(reportId);
                });
            });
        }

        // Generate a new report
        async function generateReport() {
            showLoading();
            try {
                const response = await fetch('/report/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate report');
                }
                
                const data = await response.json();
                hideLoading();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate report');
                }
                
                alert('Report generated successfully!');
                renderReports();
            } catch (error) {
                hideLoading();
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error: ' + error.message;
                console.error('Error generating report:', error);
            }
        }

        // Rerun a report
        async function rerunReport(reportId) {
            showLoading();
            try {
                const response = await fetch('/report/rerun', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ report_id: reportId })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to rerun report');
                }
                
                const data = await response.json();
                hideLoading();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to rerun report');
                }
                
                alert('Report rerun successfully!');
                renderReports();
            } catch (error) {
                hideLoading();
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error: ' + error.message;
                console.error('Error rerunning report:', error);
            }
        }

        // Add event listeners
        document.getElementById('refreshBtn').addEventListener('click', renderReports);
        document.getElementById('generateReportBtn').addEventListener('click', generateReport);

        // Load reports when the page loads
        window.addEventListener('load', renderReports);
    </script>
</body>
</html>
